<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Rune Selector</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">

  <style>
    :root{
      --bg0:#07080b;
      --bg1:#0b0f16;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.12);
      --border2: rgba(255,255,255,.18);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.66);
      --muted2: rgba(255,255,255,.52);
      --accent: #7c5cff;
      --accent2:#2fe8c3;
      --danger:#ff4d6d;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 18px;

      --safe-b: env(safe-area-inset-bottom, 0px);
      --safe-t: env(safe-area-inset-top, 0px);

      --sheet-collapsed: 76px;
      --sheet-expanded: 72vh;
    }

    *{ box-sizing:border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 800px at 20% 15%, rgba(124,92,255,.22), transparent 60%),
        radial-gradient(900px 700px at 85% 20%, rgba(47,232,195,.16), transparent 55%),
        radial-gradient(900px 700px at 50% 120%, rgba(255,77,109,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
      padding-bottom: var(--safe-b);
    }

    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.10;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
    }

    .wrap{
      height: 100%;
      display:flex;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }

    .app{
      width: min(1320px, 100%);
      height: min(900px, 100%);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: calc(var(--radius) + 6px);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      display:flex;
      flex-direction: column;
      overflow:hidden;
      position:relative;
    }

    .topbar{
      padding: 18px 20px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .title{
      display:flex;
      flex-direction: column;
      gap: 4px;
      min-width: 260px;
    }
    .title h1{
      margin:0;
      font-size: 20px;
      font-weight: 800;
      letter-spacing: .3px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .badge{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-weight: 700;
    }
    .title p{
      margin:0;
      font-size: 12.5px;
      color: var(--muted);
    }

    .controls{
      display:flex;
      align-items:center;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .search{
      position: relative;
      width: min(440px, 46vw);
      min-width: 240px;
    }

    .search input{
      width:100%;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.20);
      color: var(--text);
      padding: 11px 42px 11px 42px;
      outline:none;
      transition: border-color .15s, background .15s, box-shadow .15s;
    }
    .search input:focus{
      border-color: rgba(124,92,255,.55);
      box-shadow: 0 0 0 4px rgba(124,92,255,.18);
      background: rgba(0,0,0,.28);
    }
    .search .icon{
      position:absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      opacity:.75;
      font-size: 14px;
      color: var(--muted);
      user-select:none;
    }
    .search button{
      position:absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      padding: 8px 10px;
      border-radius: 999px;
      transition: background .15s, color .15s;
    }
    .search button:hover{ background: rgba(255,255,255,.06); color: var(--text); }

    .stat{
      border: 1px solid var(--border);
      background: rgba(0,0,0,.18);
      padding: 10px 12px;
      border-radius: 14px;
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 150px;
    }
    .stat .n{
      width: 32px; height: 32px;
      border-radius: 10px;
      display:grid;
      place-items:center;
      background: linear-gradient(135deg, rgba(124,92,255,.22), rgba(47,232,195,.16));
      border: 1px solid rgba(255,255,255,.12);
      font-weight: 900;
    }
    .stat .label{
      display:flex;
      flex-direction: column;
      line-height: 1.1;
    }
    .stat .label span:nth-child(1){
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }
    .stat .label span:nth-child(2){
      font-size: 12px;
      color: var(--muted2);
    }

    .content{
      flex:1;
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap: 16px;
      padding: 16px;
      min-height: 0;
    }

    .panel{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      border-radius: var(--radius);
      overflow:hidden;
      min-height: 0;
      display:flex;
      flex-direction: column;
    }

    .panel-hd{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .panel-hd .left{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }

    .panel-hd h2{
      margin:0;
      font-size: 13px;
      color: var(--muted);
      letter-spacing: .35px;
      text-transform: uppercase;
      font-weight: 900;
      white-space: nowrap;
    }

    .hint{
      font-size: 12px;
      color: var(--muted2);
      white-space: nowrap;
    }

    .grid{
      padding: 14px;
      display:grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 12px;
      overflow:auto;
      min-height: 0;
      -webkit-overflow-scrolling: touch;
    }

    .grid::-webkit-scrollbar,
    .chips::-webkit-scrollbar{ height: 10px; width: 10px; }
    .grid::-webkit-scrollbar-thumb,
    .chips::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.12);
      border-radius: 999px;
    }
    .grid::-webkit-scrollbar-thumb:hover,
    .chips::-webkit-scrollbar-thumb:hover{ background: rgba(255,255,255,.18); }

    @media (max-width: 1180px){
      .grid{ grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }
    @media (max-width: 760px){
      .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    .rune{
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius: 16px;
      padding: 12px;
      min-height: 132px;
      display:flex;
      flex-direction: column;
      gap: 10px;
      position:relative;
      transition: transform .15s, border-color .15s, background .15s;
      user-select:none;
      overflow:hidden;
      min-width:0;
    }

    .rune:hover{
      transform: translateY(-2px);
      border-color: rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
    }

    .rune:focus-within{
      border-color: rgba(124,92,255,.55);
      box-shadow: 0 0 0 4px rgba(124,92,255,.16);
    }

    .rune .meta{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 8px;
      min-height: 58px;
    }

    .rune .name{
      display:flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }
    .rune .name b{
      font-size: 14px;
      letter-spacing: .2px;
    }
    .rune .name small{
      color: var(--muted2);
      font-size: 12px;
    }

    .symbol{
      width: 44px; height: 44px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      font-size: 22px;
      background: rgba(0,0,0,.24);
      border: 1px solid rgba(255,255,255,.10);
      flex: 0 0 auto;
    }

    .actions{
      margin-top:auto;
      display:grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 8px;
      min-width: 0;
    }

    .btn{
      border: 1px solid var(--border);
      background: rgba(0,0,0,.18);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 10px;
      font-weight: 800;
      font-size: 12px;
      cursor:pointer;
      transition: transform .08s, background .15s, border-color .15s, opacity .15s;
      display:flex;
      align-items:center;
      justify-content: center;
      gap: 8px;
      outline:none;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      touch-action: manipulation;
    }
    .btn:hover{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.16);
    }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      background: linear-gradient(135deg, rgba(124,92,255,.26), rgba(124,92,255,.10));
      border-color: rgba(124,92,255,.35);
    }
    .btn.primary:hover{ border-color: rgba(124,92,255,.55); }

    .btn.inv{
      background: linear-gradient(135deg, rgba(47,232,195,.18), rgba(47,232,195,.07));
      border-color: rgba(47,232,195,.28);
    }
    .btn.inv:hover{ border-color: rgba(47,232,195,.48); }

    .btn:disabled{
      opacity:.38;
      cursor:not-allowed;
      transform:none;
    }

    .side{ padding: 0; }

    .side-body{
      padding: 14px;
      display:flex;
      flex-direction: column;
      gap: 12px;
      overflow:auto;
      min-height: 0;
      -webkit-overflow-scrolling: touch;
    }

    .chips{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 2px;
      max-height: 260px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    .chip{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      border-radius: 999px;
      padding: 8px 10px;
      display:flex;
      align-items:center;
      gap: 10px;
      font-size: 12px;
      white-space: nowrap;
      max-width: 100%;
    }
    .chip .tag{
      font-weight: 900;
      letter-spacing: .2px;
    }
    .chip .tag.inv{ color: rgba(47,232,195,.95); }
    .chip button{
      border:none;
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      transition: background .15s;
      flex: 0 0 auto;
      touch-action: manipulation;
    }
    .chip button:hover{ background: rgba(255,255,255,.10); }

    .outbox{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      border-radius: 16px;
      overflow:hidden;
    }

    .outbox .row{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .outbox .row b{
      font-size: 12px;
      color: var(--muted);
      letter-spacing: .35px;
      text-transform: uppercase;
    }

    .mini-actions{
      display:flex;
      gap: 8px;
      align-items:center;
    }

    .mini-btn{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--text);
      border-radius: 12px;
      padding: 9px 10px;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
      transition: background .15s, border-color .15s;
      touch-action: manipulation;
      white-space: nowrap;
    }
    .mini-btn:hover{ background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.18); }

    textarea{
      width:100%;
      height: 120px;
      resize:none;
      border:none;
      outline:none;
      padding: 12px;
      background: transparent;
      color: rgba(255,255,255,.88);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12.5px;
      line-height: 1.35;
    }

    .footer{
      padding: 14px 16px calc(14px + var(--safe-b));
      border-top: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .footer .left,
    .footer .right{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color: var(--muted);
    }

    .danger{
      border-color: rgba(255,77,109,.35) !important;
      background: linear-gradient(135deg, rgba(255,77,109,.18), rgba(255,77,109,.06)) !important;
    }
    .danger:hover{ border-color: rgba(255,77,109,.55) !important; }

    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(18px + var(--safe-b));
      transform: translateX(-50%);
      background: rgba(0,0,0,.62);
      border: 1px solid rgba(255,255,255,.16);
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      border-radius: 14px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,.55);
      font-size: 12.5px;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s, transform .18s;
      transform: translateX(-50%) translateY(10px);
      max-width: min(720px, calc(100vw - 36px));
      text-align:center;
      z-index: 60;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(0);
    }

    /* ===== MOBILE (Xiaomi 11 Lite 5G NE) ===== */
    @media (max-width: 560px){
      .wrap{ padding: 10px; }
      .app{
        height: 100%;
        width: 100%;
        border-radius: 22px;
      }

      .topbar{
        padding: calc(14px + var(--safe-t)) 12px 12px;
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }

      .title{ min-width: unset; }
      .title h1{ font-size: 18px; }
      .title p{
        font-size: 12.5px;
        line-height: 1.35;
        max-width: 44ch;
      }

      .controls{
        display:grid;
        grid-template-columns: 1fr;
        gap: 10px;
        justify-content: stretch;
      }

      .search{ width: 100%; min-width: unset; }
      .search input{
        font-size: 14px;
        padding: 12px 44px 12px 42px;
      }

      .stat{
        width: 100%;
        justify-content: space-between;
      }
      .stat .label{
        text-align:right;
        gap: 2px;
      }
      .stat .label span:nth-child(1){ font-size: 12.5px; }
      .stat .label span:nth-child(2){ font-size: 12px; }

      .mobile-actions{
        display:flex;
        width:100%;
      }

      .content{
        grid-template-columns: 1fr;
        padding: 10px;
        gap: 10px;
      }

      /* Grid panel must leave room for collapsed sheet */
      .panel.grid-panel{
        padding-bottom: calc(var(--sheet-collapsed) + 12px);
      }
      body.sheet-open .panel.grid-panel{
        padding-bottom: calc(min(var(--sheet-expanded), calc(100% - 150px)) + 12px);
      }

      /* Hide desktop side + footer on mobile (sheet replaces both) */
      aside.panel.side{ display:none; }
      .footer{ display:none; }

      .panel-hd{ padding: 12px; }
      .hint{ display:none; }

      /* Real mobile density: 2 columns for readability */
      .grid{
        grid-template-columns: repeat(2, minmax(0, 1fr));
        padding: 12px;
        gap: 12px;
      }

      .rune{
        min-height: 150px;
        padding: 12px;
      }
      .rune .meta{ min-height: 64px; }
      .rune .name b{ font-size: 14px; }
      .rune .name small{ font-size: 12px; }

      .symbol{
        width: 44px; height: 44px;
        font-size: 22px;
      }

      .btn{
        padding: 11px 10px;
        font-size: 12.5px;
      }

      /* Bottom sheet */
      .sheet{
        position:absolute;
        left: 10px;
        right: 10px;
        bottom: 10px;
        border-radius: calc(var(--radius) + 6px);
        border: 1px solid rgba(255,255,255,.10);
        background: rgba(0,0,0,.22);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        box-shadow: 0 18px 60px rgba(0,0,0,.55);
        overflow:hidden;
        z-index: 50;

        height: var(--sheet-collapsed);
        transition: height .18s ease;
        display:flex;
        flex-direction: column;
      }

      body.sheet-open .sheet{
        height: min(var(--sheet-expanded), calc(100% - 160px));
      }

      .sheet-hd{
        padding: 10px 12px;
        border-bottom: 1px solid rgba(255,255,255,.10);
        display:flex;
        align-items:center;
        justify-content: space-between;
        gap: 10px;
        min-height: 60px;
      }

      .sheet-hd-main{
        display:flex;
        flex-direction: column;
        gap: 3px;
        min-width: 0;
      }

      .sheet-hd b{
        font-size: 12px;
        color: var(--muted);
        letter-spacing: .35px;
        text-transform: uppercase;
        font-weight: 900;
      }

      .sheet-hd .sub{
        font-size: 12px;
        color: var(--muted2);
        white-space: nowrap;
        overflow:hidden;
        text-overflow: ellipsis;
        max-width: 32ch;
      }

      .sheet-body{
        padding: 12px;
        overflow:auto;
        min-height: 0;
        -webkit-overflow-scrolling: touch;
        display:flex;
        flex-direction: column;
        gap: 12px;
      }

      .chips{ max-height: 180px; }

      textarea{
        height: 110px;
        font-size: 12.5px;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="app" role="application" aria-label="Rune Selector">
      <div class="topbar">
        <div class="title">
          <h1>Rune Selector <span class="badge">v2</span></h1>
          <p>Pick runes quickly. Use <span class="kbd">Shift</span> + click for Inv. (when allowed).</p>
        </div>

        <div class="controls">
          <div class="search">
            <span class="icon">⌕</span>
            <input id="search" type="text" placeholder="Search rune name (e.g., Fehu, Algiz)..." autocomplete="off" />
            <button id="clearSearch" type="button" aria-label="Clear search">×</button>
          </div>

          <div class="stat" aria-live="polite">
            <div class="n" id="count">0</div>
            <div class="label">
              <span>Selected</span>
              <span id="subcount">0 runes</span>
            </div>
          </div>

          <!-- Mobile: real button to open the sheet -->
          <div class="mobile-actions">
            <button class="mini-btn" id="openSheet" type="button" style="width:100%;">Open selection</button>
          </div>
        </div>
      </div>

      <div class="content">
        <section class="panel grid-panel">
          <div class="panel-hd">
            <div class="left">
              <h2>Runes</h2>
              <div class="hint">Tip: click “Norm” / “Inv.”, or Shift+click a tile.</div>
            </div>
            <div class="hint" id="matchInfo"></div>
          </div>

          <div class="grid" id="grid" tabindex="0" aria-label="Rune grid"></div>
        </section>

        <!-- Desktop side panel (kept) -->
        <aside class="panel side">
          <div class="panel-hd">
            <div class="left">
              <h2>Selection</h2>
              <div class="hint">Click × to remove a rune.</div>
            </div>
          </div>

          <div class="side-body">
            <div class="chips" id="chips" aria-label="Selected runes list"></div>

            <div class="outbox">
              <div class="row">
                <b>Text output</b>
                <div class="mini-actions">
                  <button class="mini-btn" id="copy" type="button">Copy</button>
                  <button class="mini-btn" id="undo" type="button">Undo</button>
                </div>
              </div>
              <textarea id="out" readonly aria-label="Selected runes output"></textarea>
            </div>

            <div style="color: var(--muted2); font-size: 12.5px; line-height: 1.45;">
              <div style="margin-bottom:8px;"><b style="color:var(--muted)">Invertible rule:</b> only 16 runes allow inverted selections.</div>
              <div>Non-invertible runes will show a disabled “Inverted” button.</div>
            </div>
          </div>
        </aside>
      </div>

      <div class="footer">
        <div class="left">
          <button class="btn danger" id="reset" type="button">Reset</button>
          <span class="kbd">Backspace</span><span style="color:var(--muted2); font-size:12px;">Undo</span>
        </div>
        <div class="right" style="color: var(--muted2); font-size: 12px;">
          Auto-saves your selection locally.
        </div>
      </div>

      <!-- Mobile bottom sheet -->
      <div class="sheet" id="sheet" aria-label="Selection sheet" style="display:none;">
        <div class="sheet-hd" id="sheetToggle" role="button" tabindex="0" aria-expanded="false">
          <div class="sheet-hd-main">
            <b>Selection</b>
            <div class="sub" id="sheetSub">0 runes selected</div>
          </div>

          <div class="mini-actions">
            <button class="mini-btn" id="reset_m" type="button">Reset</button>
            <button class="mini-btn" id="copy_m" type="button">Copy</button>
            <button class="mini-btn" id="undo_m" type="button">Undo</button>
            <button class="mini-btn" id="closeSheet" type="button">Close</button>
          </div>
        </div>

        <div class="sheet-body">
          <div class="chips" id="chips_m" aria-label="Selected runes list (mobile)"></div>

          <div class="outbox">
            <div class="row">
              <b>Text output</b>
              <div class="mini-actions"></div>
            </div>
            <textarea id="out_m" readonly aria-label="Selected runes output (mobile)"></textarea>
          </div>

          <div style="color: var(--muted2); font-size: 12.5px; line-height: 1.45;">
            <div style="margin-bottom:8px;"><b style="color:var(--muted)">Invertible rule:</b> only 16 runes allow inverted selections.</div>
            <div>Non-invertible runes will show a disabled “Inverted” button.</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="toast" id="toast" aria-live="polite"></div>

  <script>
    // --- DATA ---
    const RUNES = [
      {name:"Fehu",     symbol:"ᚠ"},
      {name:"Uruz",     symbol:"ᚢ"},
      {name:"Thurisaz", symbol:"ᚦ"},
      {name:"Ansuz",    symbol:"ᚨ"},
      {name:"Raidho",   symbol:"ᚱ"},
      {name:"Kenaz",    symbol:"ᚲ"},
      {name:"Gebo",     symbol:"ᚷ"},
      {name:"Wunjo",    symbol:"ᚹ"},
      {name:"Hagalaz",  symbol:"ᚺ"},
      {name:"Nauthiz",  symbol:"ᚾ"},
      {name:"Isa",      symbol:"ᛁ"},
      {name:"Jera",     symbol:"ᛃ"},
      {name:"Eihwaz",   symbol:"ᛇ"},
      {name:"Perthro",  symbol:"ᛈ"},
      {name:"Algiz",    symbol:"ᛉ"},
      {name:"Sowilo",   symbol:"ᛋ"},
      {name:"Tiwaz",    symbol:"ᛏ"},
      {name:"Berkano",  symbol:"ᛒ"},
      {name:"Ehwaz",    symbol:"ᛖ"},
      {name:"Mannaz",   symbol:"ᛗ"},
      {name:"Laguz",    symbol:"ᛚ"},
      {name:"Ingwaz",   symbol:"ᛝ"},
      {name:"Dagaz",    symbol:"ᛞ"},
      {name:"Othala",   symbol:"ᛟ"},
    ];

    const INVERTIBLE = new Set([
      "Fehu","Uruz","Thurisaz","Ansuz","Raidho","Kenaz","Wunjo","Nauthiz",
      "Perthro","Algiz","Tiwaz","Berkano","Ehwaz","Mannaz","Laguz","Othala"
    ]);

    /** @type {{name:string, variant:"nor"|"inv"}[]} */
    let selected = [];
    /** @type {string[]} */
    const undoStack = [];

    const els = {
      grid: document.getElementById("grid"),
      chips: document.getElementById("chips"),
      out: document.getElementById("out"),
      count: document.getElementById("count"),
      subcount: document.getElementById("subcount"),
      search: document.getElementById("search"),
      clearSearch: document.getElementById("clearSearch"),
      matchInfo: document.getElementById("matchInfo"),
      reset: document.getElementById("reset"),
      copy: document.getElementById("copy"),
      undo: document.getElementById("undo"),
      toast: document.getElementById("toast"),

      sheet: document.getElementById("sheet"),
      sheetToggle: document.getElementById("sheetToggle"),
      sheetSub: document.getElementById("sheetSub"),
      chips_m: document.getElementById("chips_m"),
      out_m: document.getElementById("out_m"),
      copy_m: document.getElementById("copy_m"),
      undo_m: document.getElementById("undo_m"),
      reset_m: document.getElementById("reset_m"),
      closeSheet: document.getElementById("closeSheet"),
      openSheet: document.getElementById("openSheet"),
    };

    const STORAGE_KEY = "rune_selector_v2_selected";

    function isMobile(){
      return window.matchMedia && window.matchMedia("(max-width: 560px)").matches;
    }

    function toast(msg){
      els.toast.textContent = msg;
      els.toast.classList.add("show");
      window.clearTimeout(toast._t);
      toast._t = window.setTimeout(() => els.toast.classList.remove("show"), 1400);
    }

    function save(){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(selected)); }catch(e){}
    }

    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const parsed = JSON.parse(raw);
        if(Array.isArray(parsed)){
          selected = parsed
            .filter(x => x && typeof x.name === "string" && (x.variant === "nor" || x.variant === "inv"))
            .filter(x => RUNES.some(r => r.name === x.name))
            .filter(x => x.variant === "nor" || INVERTIBLE.has(x.name));
        }
      }catch(e){}
    }

    function pushUndo(){
      undoStack.push(JSON.stringify(selected));
      if(undoStack.length > 40) undoStack.shift();
    }

    function undo(){
      const snap = undoStack.pop();
      if(!snap) return;
      try{
        const prev = JSON.parse(snap);
        if(Array.isArray(prev)){
          selected = prev;
          save();
          renderAll();
          toast("Undone");
        }
      }catch(e){}
    }

    function fmtEntry(x){
      return x.variant === "inv" ? `${x.name} (Inv)` : x.name;
    }

    function updateCounts(){
      const n = selected.length;
      els.count.textContent = String(n);
      els.subcount.textContent = `${n} rune${n===1?"":"s"}`;
      if(els.sheetSub) els.sheetSub.textContent = `${n} rune${n===1?"":"s"} selected`;
    }

    function updateOutput(){
      const text = selected.map(fmtEntry).join(", ");
      els.out.value = text;
      if(els.out_m) els.out_m.value = text;
    }

    function renderChips(){
      const makeChip = (x, idx) => {
        const div = document.createElement("div");
        div.className = "chip";
        const tag = document.createElement("span");
        tag.className = "tag" + (x.variant==="inv" ? " inv" : "");
        tag.textContent = x.variant==="inv" ? "Inv" : "Nor";
        const name = document.createElement("span");
        name.textContent = x.name;

        const btn = document.createElement("button");
        btn.type = "button";
        btn.setAttribute("aria-label", `Remove ${fmtEntry(x)}`);
        btn.textContent = "×";
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          pushUndo();
          selected.splice(idx, 1);
          save();
          renderAll();
        });

        div.appendChild(tag);
        div.appendChild(name);
        div.appendChild(btn);
        return div;
      };

      els.chips.innerHTML = "";
      if(els.chips_m) els.chips_m.innerHTML = "";

      selected.forEach((x, idx) => {
        els.chips.appendChild(makeChip(x, idx));
        if(els.chips_m) els.chips_m.appendChild(makeChip(x, idx));
      });
    }

    function applyFilter(list, q){
      const s = (q || "").trim().toLowerCase();
      if(!s) return list;
      return list.filter(r => r.name.toLowerCase().includes(s));
    }

    function renderGrid(){
      const q = els.search.value || "";
      const filtered = applyFilter(RUNES, q);

      els.grid.innerHTML = "";

      if(q.trim()){
        els.matchInfo.textContent = `${filtered.length} match${filtered.length===1?"":"es"}`;
      }else{
        els.matchInfo.textContent = "";
      }

      const frag = document.createDocumentFragment();

      filtered.forEach(r => {
        const card = document.createElement("div");
        card.className = "rune";
        card.tabIndex = 0;

        const meta = document.createElement("div");
        meta.className = "meta";

        const name = document.createElement("div");
        name.className = "name";
        const b = document.createElement("b");
        b.textContent = r.name;
        const small = document.createElement("small");
        small.textContent = INVERTIBLE.has(r.name) ? "Invertible" : "Not invertible";
        name.appendChild(b);
        name.appendChild(small);

        const sym = document.createElement("div");
        sym.className = "symbol";
        sym.textContent = r.symbol;

        meta.appendChild(name);
        meta.appendChild(sym);

        const actions = document.createElement("div");
        actions.className = "actions";

        const btnNor = document.createElement("button");
        btnNor.className = "btn primary";
        btnNor.type = "button";
        btnNor.textContent = "Norm";
        btnNor.addEventListener("click", (e) => {
          e.stopPropagation();
          addRune(r.name, "nor");
        });

        const btnInv = document.createElement("button");
        btnInv.className = "btn inv";
        btnInv.type = "button";
        btnInv.textContent = "Inv.";
        const canInv = INVERTIBLE.has(r.name);
        btnInv.disabled = !canInv;
        btnInv.title = canInv ? "Add inverted" : "This rune cannot be inverted";
        btnInv.addEventListener("click", (e) => {
          e.stopPropagation();
          addRune(r.name, "inv");
        });

        actions.appendChild(btnNor);
        actions.appendChild(btnInv);

        card.addEventListener("click", (e) => {
          const wantInv = !!e.shiftKey;
          if(wantInv && INVERTIBLE.has(r.name)) addRune(r.name, "inv");
          else addRune(r.name, "nor");
        });

        card.addEventListener("keydown", (e) => {
          if(e.key === "Enter"){
            e.preventDefault();
            if(e.shiftKey && INVERTIBLE.has(r.name)) addRune(r.name, "inv");
            else addRune(r.name, "nor");
          }
        });

        card.appendChild(meta);
        card.appendChild(actions);
        frag.appendChild(card);
      });

      els.grid.appendChild(frag);
    }

    function addRune(name, variant){
      if(variant === "inv" && !INVERTIBLE.has(name)){
        toast("This rune can’t be inverted");
        return;
      }
      pushUndo();
      selected.push({name, variant});
      save();
      renderAll();
      toast(variant === "inv" ? `${name} (Inv) added` : `${name} added`);
      if(isMobile()) openSheet();
    }

    async function copyOut(){
      const text = els.out.value || "";
      if(!text.trim()){
        toast("Nothing to copy");
        return;
      }
      try{
        await navigator.clipboard.writeText(text);
        toast("Copied");
      }catch(e){
        const ta = isMobile() && els.out_m ? els.out_m : els.out;
        ta.focus();
        ta.select();
        try{
          document.execCommand("copy");
          toast("Copied");
        }catch(err){
          toast("Copy failed");
        }
        ta.setSelectionRange(ta.value.length, ta.value.length);
      }
    }

    function resetAll(){
      if(selected.length === 0){
        toast("Already empty");
        return;
      }
      pushUndo();
      selected = [];
      save();
      renderAll();
      toast("Reset");
    }

    function renderAll(){
      renderGrid();
      renderChips();
      updateCounts();
      updateOutput();
    }

    function ensureMobileShell(){
      if(isMobile()){
        els.sheet.style.display = "";
      }else{
        els.sheet.style.display = "none";
        document.body.classList.remove("sheet-open");
        els.sheetToggle.setAttribute("aria-expanded", "false");
      }
    }

    function openSheet(){
      if(!isMobile()) return;
      document.body.classList.add("sheet-open");
      els.sheetToggle.setAttribute("aria-expanded", "true");
    }

    function closeSheet(){
      document.body.classList.remove("sheet-open");
      els.sheetToggle.setAttribute("aria-expanded", "false");
    }

    function toggleSheet(){
      if(!isMobile()) return;
      if(document.body.classList.contains("sheet-open")) closeSheet();
      else openSheet();
    }

    // INIT
    load();
    ensureMobileShell();
    renderAll();

    // Events
    els.search.addEventListener("input", () => renderGrid());
    els.clearSearch.addEventListener("click", () => {
      els.search.value = "";
      els.search.focus();
      renderGrid();
    });

    els.reset.addEventListener("click", resetAll);
    els.copy.addEventListener("click", copyOut);
    els.undo.addEventListener("click", undo);

    els.copy_m.addEventListener("click", copyOut);
    els.undo_m.addEventListener("click", undo);
    els.reset_m.addEventListener("click", resetAll);
    els.closeSheet.addEventListener("click", closeSheet);
    els.openSheet.addEventListener("click", openSheet);

    els.sheetToggle.addEventListener("click", (e) => {
      const t = e.target;
      if(t && (t.id === "copy_m" || t.id === "undo_m" || t.id === "reset_m" || t.id === "closeSheet")) return;
      toggleSheet();
    });

    els.sheetToggle.addEventListener("keydown", (e) => {
      if(e.key === "Enter" || e.key === " "){
        e.preventDefault();
        toggleSheet();
      }
    });

    window.addEventListener("keydown", (e) => {
      const tag = (document.activeElement && document.activeElement.tagName) ? document.activeElement.tagName.toLowerCase() : "";
      const typing = tag === "input" || tag === "textarea";
      if(!typing && e.key === "Backspace"){
        e.preventDefault();
        undo();
      }
    });

    window.addEventListener("resize", () => {
      ensureMobileShell();
      renderGrid();
    });
  </script>
</body>
</html>
